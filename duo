#!/bin/bash

# Define colors
red='\e[31m'
yellow='\e[33m'
green='\e[32m'
none='\e[0m'

# Check if running as root
[[ $EUID != 0 ]] && {
    echo -e "\n${red}错误!${none} 当前非 ${yellow}ROOT用户.${none}\n" && exit 1
}

# Check if xray is already installed
if type xray &>/dev/null; then
    echo "检测到 xray 已安装，继续执行后续步骤."
else
    # Install xray
    echo "正在安装 xray..."
    bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)"

    # Check if xray installation is successful
    if ! type xray &>/dev/null; then
        echo -e "\n${red}错误!${none} xray 安装失败，请检查安装脚本是否正常运行.\n" && exit 1
    fi
fi

# Get local IPv4 address
local_ip=$(curl -s http://api64.ipify.org)

# Check if local_ip is a valid IPv4 address
if [[ ! $local_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "无法获取本机IPv4地址，请手动输入."
    read -p "请输入本机的IP地址: " local_ip
fi

# Create a directory to store xray configurations
config_dir="/usr/local/etc/xray/nodes"
mkdir -p "$config_dir"

# Remove existing xray configuration files
rm -f "$config_dir/config_inbound_*.json"

# Prompt user for the number of inbound nodes
read -p "请输入要添加落地socks5的数量: " num_inbounds

# Generate xray configuration file for each inbound node
for ((i=1; i<=num_inbounds; i++)); do
    vmess_id=$(cat /proc/sys/kernel/random/uuid)

    # Prompt user for socks5 proxy information for each inbound node
    read -p "请输入第 $i 个落地 SOCKS5 地址: " outbound_address
    read -p "请输入第 $i 个落地 SOCKS5 端口: " socks5_port
    read -p "请输入第 $i 个落地 SOCKS5 用户名: " socks5_username
    read -p "请输入第 $i 个落地 SOCKS5 密码: " socks5_password

    vmess_port=$((10000 + i))
    config_file="$config_dir/config_inbound_$i.json"

    # Generate xray configuration file for each inbound node
    cat > "$config_file" << EOF
{
    "inbounds": [
        {
            "listen": "0.0.0.0",
            "port": $vmess_port,
            "protocol": "vmess",
            "settings": {
                "clients": [
                    {
                        "id": "$vmess_id"
                    }
                ]
            },
            "streamSettings": {
                "network": "ws",
                "security": "none",
                "wsSettings": {
                    "path": "/dockerlnmp"
                }
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "socks",
            "settings": {
                "servers": [
                    {
                        "address": "$outbound_address",
                        "port": $socks5_port,
                        "users": [
                            {
                                "user": "$socks5_username",
                                "pass": "$socks5_password"
                            }
                        ]
                    }
                ]
            }
        }
    ]
}
EOF

    # Display connection information for each inbound node
    vmess_info="vmess://$(echo -n "{\"v\":\"2\",\"ps\":\"vmess\",\"add\":\"$local_ip\",\"port\":$vmess_port,\"id\":\"$vmess_id\",\"aid\":0,\"net\":\"ws\",\"path\":\"/dockerlnmp\",\"type\":\"none\"}" | base64 -w 0)"
    echo -e "\n${yellow}节点 $i 链接:${none}"
    echo -e "${yellow}$vmess_info${none}\n"

    # Display corresponding outbound information
    echo -e "${yellow}节点 $i 对应的落地 SOCKS5 代理信息:${none}"
    echo -e "${yellow}SOCKS5 地址: $outbound_address${none}"
    echo -e "${yellow}SOCKS5 端口: $socks5_port${none}"
done

# Restart xray with all configurations
num_configs=$(ls "$config_dir"/*.json 2>/dev/null | wc -l)
if [[ $num_configs -gt 0 ]]; then
    echo -e "\n${green}（听风脚本）已生成并启动 $num_configs 个节点配置文件，路径为/usr/local/etc/xray/nodes:${none}"
    ls "$config_dir"/*.json
    for config in "$config_dir"/*.json; do
        xray -config "$config" &
    done
else
    echo -e "\n${red}未找到任何配置文件.${none}\n"
fi
