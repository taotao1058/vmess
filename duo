#!/bin/bash

red='\e[31m'
yellow='\e[33m'
green='\e[32m'
none='\e[0m'

# 自动安装curl
install_curl() {
    if [[ -x "$(command -v apt-get)" ]]; then
        apt-get update
        apt-get install -y curl
    elif [[ -x "$(command -v yum)" ]]; then
        yum install -y curl
    else
        echo -e "\n${red}错误!${none} 无法安装 ${yellow}curl.${none} 未知的包管理器.\n" && exit 1
    fi
}

if ! type curl &>/dev/null; then
    echo -e "\n${red}错误!${none} 未找到 ${yellow}curl.${none} 正在安装...\n"
    install_curl
fi

[[ $EUID != 0 ]] && {
    echo -e "\n${red}错误!${none} 当前非 ${yellow}ROOT用户.${none}请执行sudo -i命令后再运行\n" && exit 1
}

if type xray &>/dev/null; then
    echo "检测到 xray 已安装，继续执行后续步骤."
else
    echo "正在安装 xray..."
    bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)"
    if ! type xray &>/dev/null; then
        echo -e "\n${red}错误!${none} xray 安装失败，请检查安装脚本是否正常运行.\n" && exit 1
    fi
fi

local_ip=$(curl -s http://api64.ipify.org)
if [[ ! $local_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "无法获取本机IPv4地址，请手动输入."
    read -p "请输入本机的IP地址: " local_ip
    if [[ ! $local_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "\n${red}错误!${none} 无效的IP地址.\n" && exit 1
    fi
fi

config_dir="/usr/local/etc/xray"
mkdir -p "$config_dir"

# 用户是否保留之前的入站和出站配置
read -p "是否保留之前的入站和出站配置？ [Y/N]: " keep_config

declare -A vmess_links
declare -A outbound_addresses
num_nodes=0

if [[ $keep_config == "N" || $keep_config == "n" ]]; then
    # 删除现有的xray配置文件
    rm -f "$config_dir"/*.json
else
    # 获取已有节点数量
    for f in "$config_dir"/*.json; do
        if [[ $f == *"_inbound_"* ]]; then
            num_nodes=$((num_nodes + 1))
        fi
    done
fi

for ((i=num_nodes+1; ; i++)); do
    vmess_port=$((10000 + i))
    free_port $vmess_port

    vmess_id=$(cat /proc/sys/kernel/random/uuid)

    cat > "$config_dir/inbound_$i.json" << EOF
    {
        "listen": "0.0.0.0",
        "port": $vmess_port,
        "protocol": "vmess",
        "settings": {
            "clients": [
                {
                    "id": "$vmess_id"
                }
            ]
        },
        "streamSettings": {
            "network": "ws",
            "security": "none",
            "wsSettings": {
                "path": "/dockerlnmp"
            }
        },
        "tag": "inbound$i"
    }
EOF

    vmess_link="vmess://$(echo -n "{\"v\":\"2\",\"ps\":\"节点$i\",\"add\":\"$local_ip\",\"port\":$vmess_port,\"id\":\"$vmess_id\",\"aid\":0,\"net\":\"ws\",\"path\":\"/dockerlnmp\",\"type\":\"none\"}" | base64 -w 0)"
    vmess_links[$i]="$vmess_link"

    echo "配置第 $i 个出站代理 (节点$i)"
    read -p "请输入出站sk5地址, 端口, 用户名, 密码 (以空格分隔): " addr port user pass

    outbound_addresses[$i]="$addr:$port"

    cat > "$config_dir/outbound_$i.json" << EOF
    {
        "protocol": "socks",
        "settings": {
            "servers": [
                {
                    "address": "$addr",
                    "port": $port,
                    "users": [
                        {
                            "user": "$user",
                            "pass": "$pass"
                        }
                    ]
                }
            ]
        },
        "tag": "outbound$i"
    }
EOF

    read -p "是否继续配置下一个节点？ [Y/N]: " continue_config
    if [[ $continue_config == "N" || $continue_config == "n" ]]; then
        break
    fi
done

total_config="$config_dir/config.json"
echo "{" > "$total_config"
echo "  \"inbounds\": [" >> "$total_config"

for ((i=1; i<=num_nodes; i++)); do
    cat >> "$total_config" << EOF
    {
        "listen": "0.0.0.0",
        "port": $vmess_port,
        "protocol": "vmess",
        "settings": {
            "clients": [
                {
                    "id": "$vmess_id"
                }
            ]
        },
        "streamSettings": {
            "network": "ws",
            "security": "none",
            "wsSettings": {
                "path": "/dockerlnmp"
            }
        },
        "tag": "inbound$i"
    }$(if [[ $i -lt $num_nodes ]]; then echo ","; fi)
EOF
done

for ((i=num_nodes+1; i<=num_nodes+${#vmess_links[@]}; i++)); do
    cat >> "$total_config" << EOF
    {
        "listen": "0.0.0.0",
        "port": $vmess_port,
        "protocol": "vmess",
        "settings": {
            "clients": [
                {
                    "id": "$vmess_id"
                }
            ]
        },
        "streamSettings": {
            "network": "ws",
            "security": "none",
            "wsSettings": {
                "path": "/dockerlnmp"
            }
        },
        "tag": "inbound$i"
    }$(if [[ $i -lt num_nodes+${#vmess_links[@]} ]]; then echo ","; fi)
EOF
done

echo "  ]," >> "$total_config"
echo "  \"outbounds\": [" >> "$total_config"

for ((i=1; i<=num_nodes; i++)); do
    cat >> "$total_config" << EOF
    {
        "protocol": "socks",
        "settings": {
            "servers": [
                {
                    "address": "${outbound_addresses[$i]}"
                }
            ]
        },
        "tag": "outbound$i"
    }$(if [[ $i -lt $num_nodes ]]; then echo ","; fi)
done

for ((i=num_nodes+1; i<=num_nodes+${#outbound_addresses[@]}; i++)); do
    addr_port=(${outbound_addresses[$i]})
    addr="${addr_port[0]}"
    port="${addr_port[1]}"
    user="${addr_port[2]}"
    pass="${addr_port[3]}"

    cat >> "$total_config" << EOF
    {
        "protocol": "socks",
        "settings": {
            "servers": [
                {
                    "address": "$addr",
                    "port": $port,
                    "users": [
                        {
                            "user": "$user",
                            "pass": "$pass"
                        }
                    ]
                }
            ]
        },
        "tag": "outbound$i"
    }$(if [[ $i -lt num_nodes+${#outbound_addresses[@]} ]]; then echo ","; fi)
done

echo "  ]," >> "$total_config"

# 添加路由规则
echo "  \"routing": {" >> "$total_config"
echo "    \"rules\": [" >> "$total_config"
for ((i=1; i<=num_nodes; i++)); do
    cat >> "$total_config" << EOF
    {
        "type": "field",
        "inboundTag": ["inbound$i"],
        "outboundTag": "outbound$i"
    }$(if [[ $i -lt $num_nodes ]]; then echo ","; fi)
EOF
done
for ((i=num_nodes+1; i<=num_nodes+${#outbound_addresses[@]}; i++)); do
    cat >> "$total_config" << EOF
    {
        "type": "field",
        "inboundTag": ["inbound$i"],
        "outboundTag": "outbound$i"
    }$(if [[ $i -lt num_nodes+${#outbound_addresses[@]} ]]; then echo ","; fi)
EOF
done
echo "    ]" >> "$total_config"
echo "  }" >> "$total_config"

echo "}" >> "$total_config"

systemctl restart xray
echo -e "${green}启动成功！节点配置文件路径为：${config_dir}${none}"

echo -e "\n${yellow}（TG交流群：@kexueshangwang8）（此脚本为大漂亮所写）节点链接和对应的出站代理信息:${none}"
for ((i=1; i<=num_nodes+${#vmess_links[@]}; i++)); do
    echo -e "${yellow}节点 $i 链接:${none} ${vmess_links[$i]}"
    echo -e "${yellow}节点 $i 对应的落地sk5地址:${none} ${outbound_addresses[$i]}"
done

# 查询已部署的节点
echo -e "\n${yellow}已部署的节点列表:${none}"
for ((i=1; i<=num_nodes+${#vmess_links[@]}; i++)); do
    echo -e "${yellow}节点 $i:${none}"
    echo -e "${yellow}节点链接:${none} ${vmess_links[$i]}"
    echo -e "${yellow}节点对应的落地sk5地址:${none} ${outbound_addresses[$i]}"
done
