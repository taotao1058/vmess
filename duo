#!/bin/bash

red='\e[31m'
yellow='\e[33m'
green='\e[32m'
none='\e[0m'

if ! type curl &>/dev/null; then
    echo -e "\n${red}错误!${none} 需要安装 ${yellow}curl.${none}\n" && exit 1
fi

[[ $EUID != 0 ]] && {
    echo -e "\n${red}错误!${none} 当前非 ${yellow}ROOT用户.${none}\n" && exit 1
}

if type xray &>/dev/null; then
    echo "检测到 xray 已安装，继续执行后续步骤."
else
    echo "正在安装 xray..."
    bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)"
    if ! type xray &>/dev/null; then
        echo -e "\n${red}错误!${none} xray 安装失败，请检查安装脚本是否正常运行.\n" && exit 1
    fi
fi

local_ip=$(curl -s http://api64.ipify.org)
if [[ ! $local_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "无法获取本机IPv4地址，请手动输入."
    read -p "请输入本机的IP地址: " local_ip
    if [[ ! $local_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "\n${red}错误!${none} 无效的IP地址.\n" && exit 1
    fi
fi

config_dir="/usr/local/etc/xray"
mkdir -p "$config_dir"

read -p "请输入要添加落地socks5的数量: " num_inbounds
if ! [[ $num_inbounds =~ ^[0-9]+$ ]]; then
    echo -e "\n${red}错误!${none} 无效的数量.\n" && exit 1
fi

total_config="$config_dir/config.json"
echo "{" > "$total_config"
echo "  \"inbounds\": [" >> "$total_config"

for ((i=1; i<=num_inbounds; i++)); do
    vmess_id=$(cat /proc/sys/kernel/random/uuid)
    vmess_port=$((10000 + i))

    cat >> "$total_config" << EOF
    {
        "listen": "0.0.0.0",
        "port": $vmess_port,
        "protocol": "vmess",
        "settings": {
            "clients": [
                {
                    "id": "$vmess_id"
                }
            ]
        },
        "streamSettings": {
            "network": "ws",
            "security": "none",
            "wsSettings": {
                "path": "/dockerlnmp"
            }
        }
    }$(if [[ $i -lt $num_inbounds ]]; then echo ","; fi)
EOF
done

echo "  ]," >> "$total_config"
echo "  \"outbounds\": [" >> "$total_config"

for ((i=1; i<=num_inbounds; i++)); do
    read -p "请输入第 $i 个落地 SOCKS5 地址: " outbound_address
    read -p "请输入第 $i 个落地 SOCKS5 端口: " socks5_port
    read -p "请输入第 $i 个落地 SOCKS5 用户名: " socks5_username
    read -p "请输入第 $i 个落地 SOCKS5 密码: " socks5_password

    cat >> "$total_config" << EOF
    {
        "protocol": "socks",
        "settings": {
            "servers": [
                {
                    "address": "$outbound_address",
                    "port": $socks5_port,
                    "users": [
                        {
                            "user": "$socks5_username",
                            "pass": "$socks5_password"
                        }
                    ]
                }
            ]
        }
    }$(if [[ $i -lt $num_inbounds ]]; then echo ","; fi)
EOF
done

echo "  ]" >> "$total_config"
echo "}" >> "$total_config"

if [[ $num_inbounds -gt 0 ]]; then
    systemctl restart xray
fi
